# Talava Tracker アーキテクチャ

## 概要

カメラ映像から人体姿勢を推定し、SteamVRの仮想トラッカーとして出力するシステム。

## 用途

Beat Saber撮影（操作用途ではない）

## システム構成

```
┌─────────────────────────────────────┐     ┌─────────────────────────────────┐
│              Mac                     │     │            Windows              │
│                                      │     │                                 │
│  ┌──────────┐    ┌───────────────┐  │     │  ┌─────┐    ┌─────────┐        │
│  │ カメラ   │───→│ talava-tracker│  │ OSC │  │ VMT │───→│ SteamVR │        │
│  └──────────┘    │               │──────────→│     │    │         │        │
│                  │ ・人体姿勢   │  │ UDP │  └─────┘    │  ┌──────────┐    │
│                  │   推定        │  │     │             │  │トラッカー│    │
│                  │ ・座標変換   │  │     │             │  │ ・腰     │    │
│                  │ ・平滑化     │  │     │             │  │ ・左足   │    │
│                  └───────────────┘  │     │             │  │ ・右足   │    │
│                                      │     │             │  │ ・胸     │    │
└─────────────────────────────────────┘     │             │  └──────────┘    │
                                            │             │         │        │
                                            │             │         ↓        │
                                            │             │  ┌──────────┐    │
                                            │             │  │Beat Saber│    │
                                            │             │  │(アバター)│    │
                                            │             │  └──────────┘    │
                                            │             └─────────┘        │
                                            └─────────────────────────────────┘
```

## データフロー

```
カメラ映像
    │
    ▼
┌─────────────────┐
│ 人体姿勢推定     │ ← MediaPipe等のONNXモデル
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 座標変換        │ ← カメラ座標 → ワールド座標（キャリブレーション）
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ トラッカー算出   │ ← 骨格から腰・足・胸の位置・回転を計算
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 平滑化          │ ← ジッタ除去、低域フィルタ
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ OSC送信         │ ← UDP で VMT へ
└─────────────────┘
```

## 通信プロトコル

### OSC (Open Sound Control)

- **プロトコル**: UDP
- **ポート**: 39570（VMTデフォルト）
- **アドレス**: `/VMT/Room/Unity`
- **引数**:
  | 位置 | 型     | 内容          |
  |------|--------|---------------|
  | 0    | int32  | index         |
  | 1    | int32  | enable (0/1)  |
  | 2    | float  | timeoffset    |
  | 3    | float  | x (位置)      |
  | 4    | float  | y (位置)      |
  | 5    | float  | z (位置)      |
  | 6    | float  | qx (回転)     |
  | 7    | float  | qy (回転)     |
  | 8    | float  | qz (回転)     |
  | 9    | float  | qw (回転)     |

### トラッカーindex

| index | 部位   |
|-------|--------|
| 0     | 腰     |
| 1     | 左足   |
| 2     | 右足   |
| 3     | 胸     |

## 技術スタック

### Mac側 (talava-tracker)

| 機能           | ライブラリ      |
|----------------|-----------------|
| カメラ取り込み | opencv          |
| 姿勢推定       | ort (ONNX Runtime) |
| 座標計算       | nalgebra        |
| OSC送信        | rosc            |

### Windows側

| ソフトウェア          | 役割                    |
|-----------------------|-------------------------|
| VMT                   | OSC → SteamVRトラッカー |
| SteamVR               | VRランタイム            |
| バーチャルモーションキャプチャー | アバター表示   |
| Beat Saber            | ゲーム                  |

## 座標系

### カメラ座標系
- 原点: カメラ位置
- Z軸: カメラ前方

### ワールド座標系 (SteamVR)
- 原点: キャリブレーション時の基準位置
- Y軸: 上方向
- Z軸: プレイヤー正面方向

### 変換

初期キャリブレーション時にカメラ座標系→ワールド座標系の変換行列を確定。
人体姿勢（カメラ座標系）に変換行列を適用してワールド座標を得る。

## 制約・前提

- カメラ1台、斜め45°、腰より上
- 脚の動きは控えめ前提（Beat Saber撮影のため）
- 編集前提の品質で許容
