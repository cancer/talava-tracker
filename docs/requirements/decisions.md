# 技術的意思決定ログ

開発中にユーザーが下した技術的判断の記録。

## DEC-01: アーキテクチャ

### DEC-01-1: Rust + ONNX Runtime

**決定**: 全コンポーネントをRustで実装し、推論はONNX Runtimeを使用する。

**理由**: 「全部Rustで閉じる」構成が現実的。MediaPipeはC++依存が強く、Rustから直接使うのは困難。

**代替案**: Python (MediaPipe) + Rust、またはC++直接使用 → 却下

### DEC-01-2: VMT経由でSteamVRに送信

**決定**: OSC/UDP経由でVMTにトラッカーデータを送信する。

**理由**: VMTがOpenVRドライバとして安定しており、OSCプロトコルでの連携が容易。

### DEC-01-3: 最終表示先はVMC

**決定**: Beat Saber内のCustomAvatarsではなく、VMC（バーチャルモーションキャプチャー）でアバターを表示する。

### DEC-01-4: camera_server + inference_server 分離構成

**決定**: カメラ入力（Mac）と推論（Win）を別マシン・別バイナリに分離。

**理由**: Mac側の推論負荷をなくし、Win側でGPU推論（DirectML）を可能にする。パイプラインが線形のためBevy ECSのメリットが薄く、素の関数チェーン + スレッドで構成。

**結果**: camera_server（Mac: カメラ + TCP送信）、inference_server（Win: 推論 + 三角測量 + VMT送信）の2バイナリ。TCP（bincode + LengthDelimitedCodec）で通信。

**時期**: 2026-02-23

## DEC-02: モデル選定

### DEC-02-1: MoveNet → SpinePose

**決定**: MoveNet Lightning (17kp) からSpinePose (37kp) に切り替え。

**理由**: 脊椎キーポイント（Spine01-05）が胸トラッカーに必要。MoveNetの17点では胸位置を肩中点からしか推定できなかった。

**時期**: 2026-02-09

### DEC-02-2: デフォルトモデルはspinepose_medium

**決定**: spinepose_mediumをデフォルトモデルとする。

**理由**: spinepose_smallより精度が高く、推論速度も実用範囲。

### DEC-02-3: 人物検出器はkeypoint

**決定**: `app.detector = "keypoint"`をデフォルトとする。

**理由**: 前フレームのキーポイントからバウンディングボックスを予測する方式。YOLO等の独立検出器より軽量。

## DEC-03: 三角測量方式

### DEC-03-1: 単眼3D → 複眼2D + 三角測量

**決定**: 単眼リアルタイム3Dポーズ推論の限界から、複数カメラでの2D推論+DLT三角測量に方式変更。

**理由**: 単眼の奥行き推定は胴体高さ比ベースで精度が低い。三角測量により直接メートル単位の3D座標が得られる。

**時期**: 2026-02-15

### DEC-03-2: 3台カメラ構成

**決定**: 3台カメラで冗長性を確保し、3ペアの中央値で精度向上を狙う。

**現状**: Camera 4のキャリブレーションが壊れており要修正。

### DEC-03-3: Hip基準ペア固定

**決定**: 全キーポイントでHipの最良カメラペアを使用する。

**理由**: キーポイント毎に異なるペアを選ぶと±0.3-0.4mのz軸ノイズが発生。

## DEC-04: フィルタ・平滑化

### DEC-04-1: EMA → One Euro Filter

**決定**: 指数移動平均（EMA）からOne Euro Filterに切り替え。

**理由**: EMAは静止時の安定性と動き出しの追従性を両立できない。One Euro Filterは速度に応じてカットオフ周波数を動的変更。

**時期**: 2026-02-08

### DEC-04-2: position_beta = 0.3

**決定**: 位置フィルタのbeta値を0.01から0.3に変更。

**理由**: 0.01では下半身の動き出しが遅すぎた。ユーザー確認のうえ0.3に決定。

**出典**: memo.txt

### DEC-04-3: 補間方式はextrapolate

**決定**: 推論フレーム間の補間にextrapolate（速度ベース線形外挿）を使用。

**理由**: lerpより応答が速い。回転は外挿しない（安定性のため）。

## DEC-05: トラッカー仕様

### DEC-05-1: 胸トラッカーの扱い

**決定**: あれば精度向上するが、なくても致命的ではない。安定性が問題なら外す選択も妥当。

**理由**: HMD + hip trackerの2点からIKで体幹は補間される。

**出典**: memo.txt

### DEC-05-2: 足トラッカーはankleベース

**決定**: 足トラッカーはLeftAnkle/RightAnkleをソースとし、kneeはフォールバックとする。

**理由**: ankle位置の方が前後の動きを反映しやすく、膝のIK推定精度も上がる。

**補足**: 足首位置が高い問題にはfoot_y_offsetで対処。heelキーポイントの活用は今後の課題。

**出典**: memo.txt、e2a56e3コミット

### DEC-05-3: 足位置はいったんoffset調整

**決定**: 足首の推論位置が高い問題に対し、まずはfoot_y_offsetで微調整する。heelキーポイントの活用は後回し。

**出典**: memo.txt「いったんオフセット調整で」

### DEC-05-4: 膝のpitch対応方針

**決定**: 三角測量の3D座標からpitchを計算。ノイズが問題なら2Dベースにフォールバック。

**状態**: 3Dからのpitch計算は実装済み（world_coordsモード時）。2Dフォールバックは未実装。

**出典**: memo.txt

## DEC-06: 運用

### DEC-06-1: config.tomlで設定管理

**決定**: 環境変数ではなく設定ファイル（config.toml）で全設定を管理する。

**例外**: VMT_ADDR環境変数による上書きのみ許可。

### DEC-06-2: キャリブレーションの半自動化

**決定**: hip安定検出（3秒間、標準偏差<0.3m）で自動キャリブレーション発動。手動トリガーも維持。

**問題**: 異常値でも自動発動してしまうケースがある（要改善）。

### DEC-06-3: Quest Link (Air Link) を使用

**決定**: VR接続にはQuest LinkのAir Linkを使用する。

**理由**: Steam Linkは遅すぎてNG。
