# 非機能要件

## NFR-01: 性能

### NFR-01-1: フレームレート

- VMTへの送信レート: 90FPS目標
- 推論FPS: カメラFPS（30）に律速
- 補間で推論とVMT送信のレート差を埋める

### NFR-01-2: 推論遅延

- SpinePose medium: ~40-50ms/フレーム（単眼時）
- カメラキャプチャは別スレッドで非同期化済み
- 推論もmpscチャンネル経由で非同期化済み

### NFR-01-3: 送信遅延

- 三角測量モード導入後に0.5-1sの遅延報告あり（要改善）
- 推論スレッド均等化（in_flightフラグ）で部分対処

### NFR-01-4: メモリ使用量

- 目標: 500MB以下
- 実績: ~300-400MB（推論+ウィンドウ）

## NFR-02: 精度

### NFR-02-1: 3D三角測量精度

- 再投影エラー: 実測95-101px（閾値120px）
- 3D精度: z=1.4m, fx=1273時に~13cm（フィルタ後6-7cm）

### NFR-02-2: ポーズ検出信頼度

- 信頼度閾値: 0.3
- モデル依存で変動

### NFR-02-3: 位置精度の目標

- 撮影用途（操作ではない）: 編集前提で「致命的破綻が出なければ許容」
- 通しプレイで致命的破綻が出ないレベル

## NFR-03: 安定性

### NFR-03-1: ジッター抑制

- 静止時にプルプルしないこと
- One Euro Filterで実現: position_min_cutoff=1.5で低速時の平滑化

### NFR-03-2: 動き出し追従

- 動き出しが遅すぎないこと
- position_beta=0.3で高速時のカットオフ周波数を引き上げ
- 足の動きは「控えめではなくむしろ機敏に」動くべき（Beat Saberプレイ追従）

### NFR-03-3: トラッカー暴れ防止

- 速度外れ値除去: max_displacement=0.4*scale_factor
- 解剖学的制約: max_limb_dist=1.5*scale_factor
- 左右同一位置検出でアーティファクト除去
- ステール処理で消失→再出現時のジャンプ抑制

### NFR-03-4: 長時間安定性

- 曲の開始20秒付近から足のトラッキングが怪しくなる問題が報告されている
- ステールタイムアウト（0.3s停止 / 3.0sクリア）で状態リセット

## NFR-04: 運用性

### NFR-04-1: 設定管理

- TOML形式のconfig.toml一本で全設定を管理
- パースエラーは握りつぶさず即座に報告する
- 環境変数`VMT_ADDR`でVMT送信先を上書き可能

### NFR-04-2: キャリブレーション容易性

- ランタイムキャリブレーション: コンソール入力`c`で手動発動
- 自動キャリブレーション: hip安定検出で自動発動
- ChArUcoキャリブレーション: `cargo run --bin calibrate`で対話的に実行

### NFR-04-3: ログ・診断

- 全ログをファイル出力（logs/配下）
- カメラ診断ツール（camera_probe）でハードウェア確認
- デバッグビュー（minifb）でリアルタイム確認

### NFR-04-4: ビルド・起動

- Mac側: `cargo run --bin camera_server`
- Win側: `cargo run --bin inference_server`（またはリリースバイナリ）
- 外部サービス依存なし（ONNX Runtimeは同梱）
- Mac側: macOS（AVFoundationバックエンド）
- Win側: Windows（DirectML GPU推論）

## NFR-05: 保守性

### NFR-05-1: モジュール分離

- カメラキャプチャ、姿勢推定、三角測量、トラッカー算出、VMT送信が独立モジュール
- camera_server / inference_server の2バイナリに分離

### NFR-05-2: モデル切り替え

- config.toml `app.model`で推論モデルを切り替え可能
- 新モデル追加はdetector.rsとpreprocess.rsへの追加で対応

### NFR-05-3: モデル切り替え

- inference_server.toml `model`で推論モデルを切り替え可能
