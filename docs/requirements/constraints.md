# 制約条件

## CON-01: ハードウェア制約

### CON-01-1: 実行環境

- **プラットフォーム**: macOS専用（AVFoundationバックエンド依存）
- **送信先**: Windows PC (192.168.10.35:39570) でVMT→SteamVR→VMCが動作
- **VR接続**: Quest Link（Air Link）経由。Steam Linkは遅すぎてNG

### CON-01-2: カメラ

- **内蔵カメラ**: Mac内蔵カメラ（index 0）
- **外部カメラ**: iPhone連携（Camo Camera等経由）。iPhone 7, 8, 13を使用
- **解像度**: 640x480（単眼時）/ 1760x1328, 1920x1440, 1920x1080（複眼時、カメラにより異なる）
- **カメラFPS**: 30FPS（カメラ性能に依存。設定上は60だが実効30）
- **物理配置**:
  - カメラのアイラインが肩の高さ（下半身になるほど距離が縮まる）
  - 1台では人体フルボディが映らない（上半身がフレーム外になりがち）
  - カメラの物理配置を正確にできないため、ChArUcoキャリブレーションで自動推定
- **iPhone連携の制約**:
  - 望遠モードに勝手に切り替わる問題
  - 複数iPhoneの同時認識にCamo Camera等の外部アプリが必要

### CON-01-3: ネットワーク

- **Mac→Windows**: 同一LAN内でUDP通信（ポート39570）
- **遅延**: LAN内のため無視できるレベル

## CON-02: ソフトウェア制約

### CON-02-1: 言語・ランタイム

- **Rust**: 全コンポーネントをRustで実装（「全部Rustで閉じる」方針）
- **ONNX Runtime**: 推論エンジン。CoreML対応だが効果限定的
- **OpenCV**: C++バインディング（opencv crate）。ビルド時にOpenCVライブラリが必要

### CON-02-2: 推論モデル

- ONNXフォーマットのみ対応
- モデルファイルはgit管理外（models/ディレクトリ）
- SimCC出力形式（SpinePose）とヒートマップ出力形式（MoveNet）の両方に対応

### CON-02-3: Bevy ECS

- Bevy 0.15、`default-features = false`（レンダリング無効）
- minifbのWindowはNonSendResourceとして管理（メインスレッド制約）

## CON-03: 運用制約

### CON-03-1: 用途

- **撮影用途**: Beat Saber撮影が目的。操作用途ではない
- **最終表示先**: Beat Saberのアバター（Naluluna Avatars）

### CON-03-2: キャリブレーション

- セッション開始時にキャリブレーション必須（立ち位置は毎回変わる）
- ChArUcoボードを使用（チェスボードは未所持）
- 全カメラから同時にボードが見える位置が必要（外部パラメータ推定時）

### CON-03-3: 被写体

- 撮影対象はユーザー本人
- カメラの前に立っていないとポーズ検出できない
- 人物部分がフレーム外の場合はhipのみ or no pose（単眼推定の限界）

## CON-04: 技術的制約

### CON-04-1: 推論速度のボトルネック

- SpinePose medium: ~40-50ms/フレーム
- マルチカメラ時: 各カメラ順次推論のため、カメラ数×推論時間
- 補間（extrapolate/lerp）でVMT送信レートを確保

### CON-04-2: 単眼モードの限界

- 奥行き（z軸）は胴体高さ比から推定のため精度が低い
- カメラ1台では人体フルボディを映せない場合がある
- パースペクティブ歪み（画像端で位置がずれる）

### CON-04-3: 三角測量の精度限界

- 2カメラ間の基線長・角度に依存（角度が異なるほど三角測量の精度は向上）
- **レンズ歪み補正が必須**: 歪み補正なしでは、2D観測（歪み座標）と射影行列（無歪み座標）の不一致によりリプロジェクションエラーが増大する。cam0で145-177px、cam2で1700-3300pxの歪みオフセットが実測されている
- 歪み係数: cam0 k1=0.22（穏当）、cam2 k2=11.5/k3=-49.9（極端）、cam3 k1=0.26（穏当）
- 再投影エラー閾値（MAX_REPROJ_ERROR=120px）: 歪み補正が正しく機能すれば十分な値
