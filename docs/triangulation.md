# 三角測量アルゴリズム

## 概要

複数カメラで撮影した2D画像上のキーポイント座標から、3D空間上の座標を復元する。本システムではDirect Linear Transform（DLT）法を用いる。

## 前提知識: ピンホールカメラモデル

3D空間上の点 **X** = (X, Y, Z, 1) を画像上の2D点 **x** = (u, v, 1) に写す関係は、射影行列 **P**（3x4）を用いて

```
s * x = P * X
```

と表される。sはスケール因子（奥行き）。射影行列は

```
P = K [R | t]
```

で構成される。

- **K**（3x3）: 内部パラメータ行列。焦点距離(fx, fy)と主点(cx, cy)を含む
- **R**（3x3）: カメラの回転行列（ワールド座標→カメラ座標）
- **t**（3x1）: カメラの並進ベクトル

```
K = | fx  0  cx |     [R|t] = | r11 r12 r13 t1 |
    |  0 fy  cy |             | r21 r22 r23 t2 |
    |  0  0   1 |             | r31 r32 r33 t3 |
```

1台のカメラからの1つの2D観測では、3D点は「カメラ中心から観測方向へ伸びる光線上のどこか」としかわからない。2台以上のカメラの光線の交点として3D座標を求めるのが三角測量である。

## DLT三角測量

### 原理

2D観測 **x** = (u, v, 1) と射影行列 **P** について、同次座標での射影関係 s**x** = **PX** を外積で表現すると

```
x × (P * X) = 0
```

これを展開すると、各カメラから独立な2本の方程式が得られる:

```
u * (P[2] * X) - (P[0] * X) = 0
v * (P[2] * X) - (P[1] * X) = 0
```

ここで P[i] は射影行列Pのi行目（1x4ベクトル）。N台のカメラから2N本の方程式を連立し、行列Aを構築する:

```
A * X = 0    (A: 2N x 4, X: 4x1 同次座標)
```

### 解法

AX = 0 の非自明な解は、A^T A の最小固有値に対応する固有ベクトルである。A^T A（4x4対称行列）を直接構築し、対称固有値分解で最小固有値の固有ベクトルを求める。

得られた同次座標 X = (x, y, z, w) を w で割って非同次座標 (x/w, y/w, z/w) を得る。

## レンズ歪み補正

### 歪みモデル

実際のカメラレンズは歪みを生じるため、画像上の観測座標は理想的なピンホールモデルからずれている。OpenCV互換の歪みモデル:

```
正規化座標: (x_n, y_n) = ((u - cx)/fx, (v - cy)/fy)
r² = x_n² + y_n²

径方向歪み: radial = 1 + k1*r² + k2*r⁴ + k3*r⁶
接線方向歪み:
  dx_tangential = 2*p1*x_n*y_n + p2*(r² + 2*x_n²)
  dy_tangential = p1*(r² + 2*y_n²) + 2*p2*x_n*y_n

歪み後座標:
  x_d = x_n * radial + dx_tangential
  y_d = y_n * radial + dy_tangential
```

歪み係数 [k1, k2, p1, p2, k3] はキャリブレーション時に推定される。

### 歪み補正の必要性

DLT三角測量はピンホールモデル（歪みなし）を前提とする。射影行列Pは無歪み座標系で定義されているため、2D観測もこの座標系に揃える必要がある。

歪み補正をしない場合、2D観測は歪み座標系、射影行列は無歪み座標系となり、座標系が不一致する。この不一致が三角測量の精度を直接劣化させる。

### 逆歪みモデル（歪み座標 → 無歪み座標）

歪みモデルは「無歪み → 歪み」の順方向変換は多項式評価で容易だが、逆変換「歪み → 無歪み」は解析的に解けない。Newton-Raphson法等の反復法で求める。

### 順歪みモデル（無歪み座標 → 歪み座標）

逆に、投影側に歪みを適用するアプローチもある。三角測量で得た3D点をカメラに再投影する際、無歪み投影座標に順方向歪みモデルを適用して歪み座標に変換する。多項式評価のみで反復法不要のため、任意の歪み係数に対して安定して動作する。

## リプロジェクションエラー

三角測量の品質指標。推定した3D点を各カメラに再投影し、元の2D観測との距離（ピクセル）を測る。

```
X_3d → カメラiで再投影 → (u_proj, v_proj) = P * X_3d / w
エラー = sqrt((u_proj - u_obs)² + (v_proj - v_obs)²)
```

2D観測と再投影のピクセル座標は同じ座標系（歪みあり or 歪みなし）で比較しなければならない。

## カメラキャリブレーション

三角測量に必要なカメラパラメータ（K, dist_coeffs, R, t）はChArUcoキャリブレーションで推定する。

### ChArUcoボード

既知の幾何学パターン（チェスボード + ArUcoマーカー）。マーカーにより部分的な遮蔽や画面外にも対応できる。

キャリブレーションに必要な物理情報:
- マス数（squares_x, squares_y）
- マス辺長（square_length, メートル単位）
- マーカー辺長（marker_length, メートル単位）

これらの実測値が、三角測量結果のメートルスケールを決定する。

### 内部パラメータ推定

各カメラで個別にChArUcoボードを様々な角度から撮影し、以下を推定する:

- **入力**: 1台のカメラで撮影した複数フレームのChArUcoコーナー座標
- **出力**: 内部パラメータ行列K（fx, fy, cx, cy）と歪み係数（k1, k2, p1, p2, k3）
- **品質指標**: 再投影誤差（ピクセル単位）。ボードコーナーの3D既知位置を推定パラメータで再投影し、検出位置との誤差を測る

### 外部パラメータ推定

全カメラから同時にChArUcoボードが見える状態で、カメラ間の相対姿勢を推定する。

- **入力**: 全カメラの内部パラメータ（K, dist_coeffs）、全カメラで同時に検出したChArUcoコーナー座標
- **処理**: 各カメラの画像を歪み補正してからコーナー検出し、solvePnP（歪み=0）でボードに対する各カメラの姿勢（rvec, tvec）を推定。最初のカメラを基準（rvec/tvec=0）として相対姿勢を算出
- **出力**: 各カメラのrvec（Rodrigues回転ベクトル）とtvec（並進ベクトル）。基準カメラからの相対姿勢

### キャリブレーション結果

calibration.jsonに保存される。各カメラについて:
- camera_index, width, height
- intrinsic_matrix（K, 3x3, row-major）
- dist_coeffs（[k1, k2, p1, p2, k3]）
- rvec, tvec（基準カメラからの相対姿勢）
- reprojection_error（内部パラメータ推定時の再投影誤差）

射影行列 P = K[R|t] はrvecからRodrigues変換で回転行列Rを得て構築する。

## カメラ配置と三角測量精度

### 基線長と視差角

三角測量の精度は、2台のカメラの「視差角」（同一3D点を見る2つの光線がなす角度）に依存する。

- **視差角が大きい**（カメラ間の角度差が大きい）: 光線の交差が鋭角になり、奥行き方向の精度が向上する
- **視差角が小さい**（カメラがほぼ同方向を向いている）: 光線がほぼ平行になり、交点の奥行き方向の不確定性が増大する

カメラ間の物理的距離（基線長）が大きいほど、また光軸の角度差が大きいほど、視差角は大きくなる。

### カメラのチルト（傾き）

カメラを異なる高さ・角度に配置することは三角測量に有利に働く:

- 水平方向のみの基線長では、水平方向の精度は高いが垂直方向の精度が限定的
- 上方から見下ろすカメラを加えることで、垂直方向の視差角も確保できる
- 異なるチルト角のカメラは、同一キーポイントを異なる方向から観測するため、3軸すべての精度が向上する

### 3台以上のカメラ

DLT法はN台のカメラから2N本の方程式を構築するため、カメラ数が増えるほど過決定系となり、ノイズに対するロバスト性が向上する。ただし、各カメラペアの精度は視差角に依存するため、角度の異なるカメラを追加することが重要である。

## 入出力仕様

### 入力

- N台のカメラのカメラパラメータ（射影行列P、内部パラメータK、歪み係数）
- N台のカメラの2Dポーズ（各キーポイントの正規化座標(0-1)とconfidence）

### 出力

- 3Dポーズ: 各キーポイントの3D座標（メートル単位、基準カメラ座標系）とconfidence
  - 2台以上のカメラで検出され、リプロジェクションエラーが閾値以下のキーポイントのみconfidence > 0
  - それ以外のキーポイントはconfidence = 0

### 満たすべき性質

1. **座標系の一貫性**: 2D観測と射影行列が同じ座標系（歪みあり/なし）で計算されること
2. **自己整合性**: 同じ射影行列で投影→三角測量した場合、リプロジェクションエラーはほぼ0になること
3. **z値の一貫性**: 同一フレーム内の全キーポイントが同じ奥行きバイアスを持つこと（異なるカメラペアを混在させない）
4. **時間的連続性**: フレーム間でhipのz値が物理的にありえない速度で変化しないこと

## 座標系

- **カメラ座標系**: 基準カメラ（cam0）の座標系。cam0のrvec/tvec = 0
  - X: 右方向
  - Y: 下方向
  - Z: カメラの前方（奥行き）
- **トラッカー座標系**: BodyTrackerがキャリブレーション時の基準位置からの相対座標に変換する
